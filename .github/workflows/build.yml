name: Build Windows EXE

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 配置 Node.js (保持版本 20)
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    # 3. 编译前端 Vue
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build
        dir dist

    # 4. 配置 Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 5. 安装 Python 依赖
    - name: Install Python Dependencies
      run: |
        pip install -r requirements.txt

    # 6. 使用 PyInstaller 打包 (关键修改在此处)
    # 修改说明：
    # 1. --paths "backend": 告诉 Python 在 backend 目录下查找模块 (解决了 No module named 'models')
    # 2. --add-data: 格式改为 Windows 风格的分号
    # 3. --hidden-import: 显式强制引入 models 和 database
    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --noconfirm --onefile --windowed --clean --name "校企实时对接数字化平台" --paths "backend" --add-data "frontend/dist;frontend/dist" --hidden-import "models" --hidden-import "database" --hidden-import "uvicorn.logging" --hidden-import "uvicorn.loops" --hidden-import "uvicorn.loops.auto" --hidden-import "uvicorn.protocols" --hidden-import "uvicorn.protocols.http" --hidden-import "uvicorn.protocols.http.auto" --hidden-import "uvicorn.lifespan" --hidden-import "uvicorn.lifespan.on" backend/main.py

    # 7. 上传生成的 EXE
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Qingyang-Platform-Windows-EXE
        path: dist/平台.exe