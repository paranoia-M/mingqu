name: Build Smart Monitor System

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    # 升级到 v4
    - name: Checkout code
      uses: actions/checkout@v4

    # 升级到 v5
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Create PyInstaller Spec file
      run: |
        echo "Creating build.spec..."
        python -c "
        import streamlit
        import os
        streamlit_path = os.path.dirname(streamlit.__file__)
        
        spec_content = f'''
        # -*- mode: python ; coding: utf-8 -*-
        from PyInstaller.utils.hooks import collect_all

        datas = [
            (r'{streamlit_path}', 'streamlit'),
            ('core', 'core'),
            ('database', 'database'),
            ('simulator.py', '.'),
            ('vision_sensor.py', '.'),
            ('dashboard_final.py', '.')
        ]
        binaries = []
        hiddenimports = [
            'streamlit', 'pandas', 'numpy', 'altair', 'pydeck', 'plotly', 
            'uvicorn', 'fastapi', 'sqlalchemy', 'cv2', 'requests'
        ]

        tmp_ret = collect_all('streamlit')
        datas += tmp_ret[0]; binaries += tmp_ret[1]; hiddenimports += tmp_ret[2]
        
        tmp_ret = collect_all('altair')
        datas += tmp_ret[0]; binaries += tmp_ret[1]; hiddenimports += tmp_ret[2]
        
        tmp_ret = collect_all('plotly')
        datas += tmp_ret[0]; binaries += tmp_ret[1]; hiddenimports += tmp_ret[2]

        block_cipher = None

        a = Analysis(
            ['run.py'],
            pathex=[],
            binaries=binaries,
            datas=datas,
            hiddenimports=hiddenimports,
            hookspath=[],
            hooksconfig={{}},
            runtime_hooks=[],
            excludes=[],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=block_cipher,
            noarchive=False,
        )
        pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

        exe = EXE(
            pyz,
            a.scripts,
            [],
            exclude_binaries=True,
            name='SmartChannelMonitor',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            console=True,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
        )
        coll = COLLECT(
            exe,
            a.binaries,
            a.zipfiles,
            a.datas,
            strip=False,
            upx=True,
            upx_exclude=[],
            name='SmartChannelMonitor',
        )
        '''
        with open('build.spec', 'w', encoding='utf-8') as f:
            f.write(spec_content)
        "

    - name: Build with PyInstaller
      run: pyinstaller build.spec

    # 关键修复：这里必须用 v4，否则会报错
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SmartChannelMonitor-Windows
        path: dist/SmartChannelMonitor