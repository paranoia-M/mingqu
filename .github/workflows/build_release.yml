name: Build and Archive on Push

on:
  push:
    branches:
      - main
      - develop

jobs:
  build_windows_exe:
    runs-on: windows-latest  # 使用 Windows 虚拟机进行构建
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        # 升级 pip 并安装所有依赖 (包括打包和运行时)
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller psutil  # 确保打包工具和进程管理工具安装

    - name: Build the EXE with PyInstaller
      id: build_exe
      shell: pwsh # 使用 PowerShell 来处理 Windows 路径和文件创建
      run: |
        # 1. 定义输出文件名和文件夹
        $timestamp = Get-Date -Format "yyyyMMdd-HHmm"
        $branch_name = "${{ github.ref_name }}"
        $output_folder_name = "ChannelMonitor-${branch_name}-$timestamp"
        
        # 2. 执行 PyInstaller 打包 (使用 --onedir 文件夹模式)
        pyinstaller dashboard_final.py `
        --name "ChannelMonitor" `            # 生成的可执行文件名
        --distpath "dist/$output_folder_name" ` # 指定输出目录
        --onedir `                           # 使用文件夹模式
        --noconsole `
        --collect-all "plotly" `
        --collect-all "streamlit" `
        --collect-all "pandas" `
        --add-data "core;core" `
        --add-data "database;database" `
        --add-data "simulator.py;." `
        --add-data "vision_sensor.py;."
        
        # 3. 创建启动批处理文件 (Start.bat)
        # 这个文件将用于在 Windows 上启动应用 (解决权限和解释器问题)
        $bat_content = "@echo off`r`nstart /B ChannelMonitor.exe"
        Set-Content -Path "dist/$output_folder_name/Start.bat" -Value $bat_content
        
        # 4. 将最终文件夹名传递给 Artifacts 步骤
        echo "::set-output name=output_name::$output_folder_name"

    - name: Archive Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChannelMonitor-${{ github.ref_name }}-Portable
        # 路径指向整个打包文件夹
        path: dist/${{ steps.build_exe.outputs.output_name }}