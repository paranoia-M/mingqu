name: Build and Archive on Push

on:
  push:
    branches:
      - main
      - develop

jobs:
  build_for_windows:
    # 使用 Ubuntu Runner
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run PyInstaller Cross-Platform Build
      # 使用专门的跨平台打包 Action
      uses: pytool/pyinstaller-action-windows@v2 
      with:
        python_version: '3.9'
        requirements_file: requirements.txt
        # 指定主文件和 SPEC 文件，并设置最终 EXE 的名称
        script_file: dashboard_final.py 
        spec_file: build.spec
        spec_name: ChannelMonitor # 最终 EXE 的名称
        
        # 禁用默认的打包步骤，因为我们使用 SPEC 文件
        pre_build: |
          echo "Using custom build.spec for complex dependencies."
        
        # 明确输出目录，用于后续上传
        output_dir: dist/ChannelMonitor-Output
        
    - name: Get Build Folder Name
      id: get_name
      shell: bash
      run: |
        # 创建时间戳作为文件夹名
        timestamp=$(date +'%Y%m%d-%H%M')
        folder_name="ChannelMonitor-${{ github.ref_name }}-$timestamp"
        echo "::set-output name=folder_name::$folder_name"
        
    - name: Create Launch Script and Organize
      shell: bash
      run: |
        # 1. 重命名 PyInstaller 生成的文件夹
        mv dist/ChannelMonitor-Output/ChannelMonitor dist/${{ steps.get_name.outputs.folder_name }}
        
        # 2. 创建 Start.bat 启动脚本
        echo "@echo off" > dist/${{ steps.get_name.outputs.folder_name }}/Start.bat
        echo "start /B ChannelMonitor.exe" >> dist/${{ steps.get_name.outputs.folder_name }}/Start.bat

    - name: Archive Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChannelMonitor-Portable
        path: dist/${{ steps.get_name.outputs.folder_name }}