name: Build and Archive on Push

on:
  push:
    branches:
      - main
      - develop

jobs:
  build_for_windows:
    # 关键：使用 Docker 容器，并指定目标系统
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up QEMU (for cross-platform emulation)
      uses: docker/setup-qemu-action@v2
      
    - name: Build and Publish (using PyInstaller Docker)
      uses: crazy-max/ghaction-dockerize@v2
      with:
        # 使用 PyInstaller 官方维护的容器，专门用于跨平台打包
        image: cdrx/pyinstaller-windows:python3.9
        name: pyinstaller-build
        workdir: /src
        run: |
          # 1. 安装项目依赖
          pip install -r requirements.txt
          
          # 2. 执行 PyInstaller 打包，使用 build.spec 文件
          # 容器内部会生成 ChannelMonitor 文件夹
          pyinstaller build.spec
          
          # 3. 复制启动脚本和 EXE 到指定目录
          mkdir /dist
          cp -r dist/ChannelMonitor /dist/
          
          # 4. 创建 Start.bat 启动脚本
          echo "@echo off" > /dist/ChannelMonitor/Start.bat
          echo "start /B ChannelMonitor.exe" >> /dist/ChannelMonitor/Start.bat

    - name: Archive Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChannelMonitor-${{ github.ref_name }}-Windows-Portable
        # 上传 Docker 容器生成的最终交付文件夹
        path: /dist/ChannelMonitor