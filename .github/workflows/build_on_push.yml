name: Deliver Source Code for Windows

on:
  push:
    branches:
      - main
      - develop

jobs:
  deliver_source_package:
    runs-on: windows-latest  # 使用 Windows 确保文件格式正确
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: '3.9'
        
    - name: Install dependencies (To ensure consistency)
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # 安装完成后，我们就可以打包这些依赖了

    - name: Create Launch Scripts
      id: create_scripts
      shell: pwsh # 使用 PowerShell
      run: |
        $timestamp = Get-Date -Format "yyyyMMdd-HHmm"
        $output_folder_name = "ChannelMonitor-Source-$timestamp"
        echo "::set-output name=output_name::$output_folder_name"
        
        # 1. 创建启动后端服务器的脚本
        # 注意：使用 start 命令启动子窗口
        Set-Content -Path StartBackend.bat -Value "start /B cmd /c python main.py"
        
        # 2. 创建启动前端应用的脚本
        Set-Content -Path StartFrontend.bat -Value "start /B cmd /c streamlit run dashboard_final.py"

        # 3. 创建总启动脚本 (先后端，后前端)
        $full_launch = @(
            "@echo off",
            "echo Starting Monitor System...",
            "start /B cmd /c python main.py",
            "timeout /t 5 /nobreak >NUL", # 等待5秒确保后端启动
            "start /B cmd /c streamlit run dashboard_final.py",
            "echo System fully launched. Do not close these windows.",
            "pause"
        )
        Set-Content -Path StartMonitor.bat -Value ($full_launch -join "`r`n")
        
    - name: Prepare Archive and Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChannelMonitor-Source-Package
        # 打包整个项目文件夹
        path: |
          ./**
          !./.git/**