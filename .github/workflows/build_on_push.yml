name: Build and Archive on Push (No SPEC)

on:
  push:
    branches:
      - main
      - develop

jobs:
  build_windows_exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller psutil

    - name: Build the EXE with PyInstaller (CLI OVERLOAD)
      id: build_exe
      shell: pwsh
      run: |
        $timestamp = Get-Date -Format "yyyyMMdd-HHmm"
        $branch_name = "${{ github.ref_name }}"
        $output_folder_name = "ChannelMonitor-${branch_name}-$timestamp"
        $output_path = "dist/$output_folder_name"

        # 核心修复：添加 --hidden-import streamlit 和 streamlit-component-lib
        $command_args = @(
            "dashboard_final.py",
            "--name", "ChannelMonitor", 
            "--distpath", $output_path,
            "--onedir", 
            "--noconsole", 
            
            # --- 强制导入核心 Python 模块 (解决 ModuleNotFoundError) ---
            "--hidden-import", "streamlit",
            "--hidden-import", "streamlit.cli",
            "--hidden-import", "streamlit.web",
            
            # --- 强制收集依赖 (避免 DLL 缺失) ---
            "--collect-all", "plotly", 
            "--collect-all", "streamlit", 
            "--collect-all", "pandas",
            "--collect-all", "uvicorn", 
            "--collect-all", "fastapi",
            "--collect-all", "numpy",
            "--collect-all", "cv2", 
            
            # --- 强制添加项目数据文件 ---
            "--add-data", "core;core", 
            "--add-data", "database;database",
            "--add-data", "simulator.py;.",
            "--add-data", "vision_sensor.py;."
        )
        
        Write-Host "Starting PyInstaller build..."
        python -m PyInstaller $command_args
        
        if (Test-Path $output_path) {
            $bat_content = "@echo off`r`nstart /B ChannelMonitor.exe"
            Set-Content -Path "$output_path/Start.bat" -Value $bat_content
        } else {
            Write-Host "Error: PyInstaller build failed or output directory not found."
            exit 1
        }

        echo "::set-output name=output_name::$output_folder_name"

    - name: Archive Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChannelMonitor-${{ github.ref_name }}-Portable
        path: dist/${{ steps.build_exe.outputs.output_name }}