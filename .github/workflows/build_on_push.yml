name: Build and Archive on Push (Nuitka Compiler)

on:
  push:
    branches:
      - main
      - develop

jobs:
  build_windows_exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: '3.9'
        
    # 关键：安装 Visual Studio Build Tools (C++ Compiler)
    - name: Install MSVC Build Tools
      uses: ilammy/msvc-dev-cmd@v1 
      
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip pip install nuitka zstd  # 安装 Nuitka 编译器

    - name: Build the EXE with Nuitka
      id: build_exe
      shell: pwsh # 使用 PowerShell
      run: |
        $timestamp = Get-Date -Format "yyyyMMdd-HHmm"
        $branch_name = "${{ github.ref_name }}"
        $output_name = "ChannelMonitor-$timestamp"
        
        # 1. Nuitka 编译命令
        # --standalone: 打包所有依赖
        # --include-data-dir: 强制包含 Streamlit 和项目资源
        
        nuitka --standalone --onefile `
        --output-dir="dist/$output_name" `
        --output-filename="ChannelMonitor" `
        --include-package=streamlit --include-package=plotly `
        --include-package=pandas --include-package=numpy `
        --include-package=uvicorn --include-package=fastapi `
        --include-data-dir="core=core" `
        --include-data-dir="database=database" `
        --include-data-file="simulator.py=simulator.py" `
        --include-data-file="vision_sensor.py=vision_sensor.py" `
        dashboard_final.py
        
        # 2. 传递文件夹名给 Artifacts 步骤
        echo "::set-output name=output_name::$output_name"

    - name: Archive Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChannelMonitor-Nuitka-Portable
        # Nuitka 打包通常生成一个文件夹，我们上传这个文件夹
        path: dist/${{ steps.build_exe.outputs.output_name }}